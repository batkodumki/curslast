unit UForm;

interface

uses
  Types, Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, Series, GanttCh, TeEngine, ExtCtrls, TeeProcs, Chart, StdCtrls,
  RXSpin;

type
  TFormDynScaleInt = class(TForm)
    LabelA: TLabel;
    LabelB: TLabel;
    LabelIs: TLabel;
    LabelThan: TLabel;
    PanelScale: TPanel;
    PanelScaleChoice: TPanel;
    RButInteger: TRadioButton;
    RButBalanced: TRadioButton;
    RButPower: TRadioButton;
    RButMaZheng: TRadioButton;
    RButDodd: TRadioButton;
    PanelLess: TPanel;
    PanelMore: TPanel;
    ImageShow: TImage;
    PanelNoIdea: TPanel;
    RxSpinButGradChange: TRxSpinButton;
    PanelScaleButtonChoice: TPanel;
    procedure FormShow(Sender: TObject);
    procedure PanelScaleClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormMouseWheelDown(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure FormMouseWheelUp(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormMouseWheel(Sender: TObject; Shift: TShiftState;
      WheelDelta: Integer; MousePos: TPoint; var Handled: Boolean);
    procedure PanelNoIdeaClick(Sender: TObject);
    procedure FormMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure PanelNoIdeaMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure PanelScaleMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure PanelScaleChoiceClick(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure RxSpinButGradChangeTopClick(Sender: TObject);
    procedure RxSpinButGradChangeBottomClick(Sender: TObject);
    procedure PanelScaleButtonChoiceClick(Sender: TObject);
  private
    { Private declarations }
    ScaleStr:string;
    Data:Extended;
    LogFont: TLogFont;
    Font_: THandle;
    DelayWheel: integer;
    procedure ShowImage;
    procedure BuildScale(const aScaleStr:string);
    function IntegerByScale(const aData:Extended):Extended;
  public
    { Public declarations }
    Reverse: integer; //0-less,1-more
    Rel,Res: Extended;//RELiability, RESult estimate
    ScaleType: integer;
    procedure DoShowHint(var HintStr: String; var CanShow: Boolean; var HintInfo: THintInfo);
  end;

const Pref:array[1..9] of string=//UA ('Підтверджую'{Не можу уточнити'визначитись'Equally'{1},'Слабко або незначно'{2},'Середнє'{3},    'Більше ніж середнє'{4},'Сильно'{5},'Більше ніж сильно'{6},'Дуже сильно'{7},'Дуже, дуже сильно'{8},'Абсолютно'{9});
      ('Confirm'{No idea'Equally'{1},'Weakly or slightly'{2},'Moderately'{3},    'Moderately plus'{4},'Strongly'{5},'Strongly plus'{6},'Very strongly'{7},'Very, very strongly'{8},'Extremely'{9});
      LessMore:array[0..2] of string =//UA ('Менше','Більше', 'Не можу визначитись');  //('Гірша','Краща');
      ('Less','More', 'Not sure');
      GradualScale:array[2..8] of string=('25','259','3579','23579','234579','2345679','23456789');
var
  FormDynScaleInt: TFormDynScaleInt;

implementation

uses Math;

{$R *.dfm}

procedure TFormDynScaleInt.ShowImage;
var i,minL,maxR: integer;
begin
  with ImageShow do begin
    SelectObject(Canvas.handle, Font_);
    Canvas.FillRect(ClientRect);
    minL:=Width;
    maxR:=0;
    for i:=0 to PanelScale.ControlCount-1 do begin
      Canvas.TextOut(TPanel(PanelScale.Controls[i]).Left+TPanel(PanelScale.Controls[i]).Width div 2 - Canvas.TextHeight(TPanel(PanelScale.Controls[i]).Hint) div 2, Canvas.TextWidth(TPanel(PanelScale.Controls[i]).Hint)+1, TPanel(PanelScale.Controls[i]).Hint);
      Canvas.MoveTo(TPanel(PanelScale.Controls[i]).Left,0);
      Canvas.LineTo(TPanel(PanelScale.Controls[i]).Left,10);
      if minL>TPanel(PanelScale.Controls[i]).Left then
        minL:=TPanel(PanelScale.Controls[i]).Left;
      if maxR<(TPanel(PanelScale.Controls[i]).Left+TPanel(PanelScale.Controls[i]).Width) then
        maxR:=TPanel(PanelScale.Controls[i]).Left+TPanel(PanelScale.Controls[i]).Width;
    end;
    Canvas.MoveTo(maxR-1,0);
    Canvas.LineTo(maxR-1,10);
    Canvas.MoveTo(minL,0);
    Canvas.LineTo(maxR-1,0);
    Invalidate;
  end;
end;

procedure TFormDynScaleInt.FormShow(Sender: TObject);
const sc=' Scale'; //UA ' шкала';
begin
  Reverse:=-1;
  Res:=1; // не можу конкретніше визначитись
  Rel:=0;//мінімальна вага оцінки "не можу конкретніше визначитись, уточнити"
  ScaleStr:='0';
  //UACaption:='Зробіть вибір, користуючись візуальними підказками про співвідношення, що Ви вибираєте';
  //UARxSpinButGradChange.Hint:='Змінити кількість градацій шкали';
  //UAPanelScaleButtonChoice.Caption:='Підбір шкали';
  //UAPanelScaleButtonChoice.Hint:='Змінити тип шкали (для досвідчених користувачів)';
  PanelScaleButtonChoice.BevelOuter:=bvLowered;
  PanelScaleButtonChoiceClick(PanelScaleButtonChoice);
//  LabelA.Caption:='Альтернатива А';
//  LabelB.Caption:='Альтернатива В';
  //UA LabelIs.Caption:='впливає';//'';'is';
  LabelIs.Hint:=LabelIs.Caption;//'';'is';
  //UA LabelThan.Caption:='ніж';
  //UA PanelNoIdea.Caption:='Не можу визначити';
  PanelNoIdea.Hint:=PanelNoIdea.Caption;
  PanelLess.Caption:=LessMore[0];//'Гірша'
  PanelMore.Caption:=LessMore[1];//'Краща'
  PanelLess.Color:=clRed;
  PanelMore.Color:=clRed;
  with LogFont do begin
    lfheight := 10;
    lfwidth := 6;
    lfweight := FW_THIN	;
    lfEscapement := 900;
    lfQuality := PROOF_QUALITY;//	draft_quality; DEFAULT_QUALITY
    lfItalic := 0;//false;
    lfUnderline := 0;//false;
    lfStrikeOut:= 0;//false;
    lfCharSet := DEFAULT_CHARSET;
    lfFaceName := 'Arial';//MS Sans Serif';
    lfOutPrecision := OUT_DEFAULT_PRECIS; //out_tt_precis;
    lfClipPrecision := CLIP_DEFAULT_PRECIS;
    lfPitchAndFamily := DEFAULT_PITCH; //FF_Modern;
  end;//with
  Font_ := CreateFontIndirect(LogFont);
  SetBKmode(ImageShow.Canvas.handle, transparent);
  ImageShow.Left:=PanelScale.Left;
  ImageShow.Width:=PanelScale.Width;
  BuildScale(ScaleStr);
  ShowImage;
  //UA RButInteger.Caption:='Цілочислова'; // 'Integer';
  RButInteger.Hint:=RButInteger.Caption+sc;
  //UA RButBalanced.Caption:='Збалансована'; // 'Balanced';
  RButBalanced.Hint:=RButBalanced.Caption+sc;
  //UA RButPower.Caption:='Степенева'; // 'Power';
  RButPower.Hint:=RButPower.Caption+sc;
  //UA RButMaZheng.Caption:='Ма-Чженга (9/9-9/1)';// 'Ma-Zheng (9/9-9/1)'
  RButMaZheng.Hint:=RButMaZheng.Caption+sc;
  //UA RButDodd.Caption:='Донеган-Додд-МакМастера'; // 'Donegan-Dodd-McMasters';
  RButDodd.Hint:=RButDodd.Caption+sc;
  PanelScaleChoice.Hide;
  Constraints.MaxHeight:=Height;
  Constraints.MinHeight:=Height;
end;

function TFormDynScaleInt.IntegerByScale(const aData:Extended):Extended;
begin
  Result:=aData;
  if RButBalanced.Checked then
    Result:=(0.5+(aData-1)*0.05)/(0.5-(aData-1)*0.05);
  if RButPower.Checked then
    Result:=Power(9,(aData-1)/8);
  if RButMaZheng.Checked then
    Result:=9/(9+1-aData);
  if RButDodd.Checked then
    Result:=exp(ArcTanh((aData-1)/14*sqrt(3)));//6*sqrt(3));
end;

procedure TFormDynScaleInt.BuildScale(const aScaleStr:string);
var NewPin:TPanel;
    i,ii,li,wi:integer;
    sumW:extended;

  procedure AddNewPin(aCaption: string);
  begin
    NewPin:=TPanel.Create(PanelScale);
    with NewPin do begin
      OnClick:=PanelScaleClick;
      OnMouseMove:=PanelScaleMouseMove;
      ShowHint:=true;
      Height:=PanelScale.Height;
      Alignment:=taLeftJustify;
      Caption:=''; //aCaption
      Hint:=aCaption;
      Cursor:=crHandPoint;
    end;//with NewPin
    PanelScale.InsertControl(NewPin);
  end;//proc AddNewPin

begin
  li:=length(aScaleStr);
  while PanelScale.ControlCount<>li+1 do
    if PanelScale.ControlCount<=li then
      AddNewPin('')
    else begin
      NewPin:=TPanel(PanelScale.Controls[PanelScale.ControlCount-1]);
      PanelScale.RemoveControl(NewPin);
      NewPin.Free
    end;

  if Reverse=-1 then
    for i:=0 to PanelScale.ControlCount-1 do
    with PanelScale.Controls[i] as TPanel do begin
      Width:=PanelScale.Width div PanelScale.ControlCount;
      Left:=i*Width;
      Hint:=Caption;
    end
  else begin
    li:=PanelScale.ControlCount-1;//last i
    sumW:=0; // Сумарна вага кнопок(знач. в шкалі), що відповідає ширині кожної з кнопок
    if (aScaleStr='23459')or(aScaleStr='25679')or(aScaleStr='2589') then
      ii:=8
    else
      ii:=li;
    for i:=1 to ii do
      sumW:=sumW + IntegerByScale(1.5+(i-0.5)*(9.5-1.5)/ii);
    wi:=0; //  if Reverse = 0 then  //Less Гірша
    for i:=li downto 0 do
      with PanelScale.Controls[i] as TPanel do begin
        if i=li then begin
          Width:=PanelScale.Width div 9;// div 2;
          wi:=Width;
          if Reverse=1 then Left:=0 else Left:=PanelScale.Width-Width;
          Caption:=LessMore[1-Reverse];
          Hint:=LessMore[1-Reverse];
          Color:=clBtnFace;
        end else//if
        begin
          if (aScaleStr='23459')or(aScaleStr='25679')or(aScaleStr='2589') then begin
            if RButInteger.Checked then
              Width:=PanelScale.Width*16div 9div 6;
            if ((aScaleStr='23459')and(Pos(aScaleStr[li-i],aScaleStr)>3))
             or ((aScaleStr='25679')and not InRange(Pos(aScaleStr[li-i],aScaleStr),2,4))
             or ((aScaleStr='2589')and (Pos(aScaleStr[li-i],aScaleStr)<3))
            then begin
              if not RButInteger.Checked then begin
                if ((aScaleStr='25679')or(aScaleStr='2589'))and(aScaleStr[li-i]='2') then
                  Width:=round(PanelScale.Width div 2*16div 9/sumW*(IntegerByScale(2)+IntegerByScale(3)+IntegerByScale(4)) )//ширина кнопки потрійної("234")
                else if ((aScaleStr='23459')or (aScaleStr='2589'))and(aScaleStr[li-i]='5') then
                  Width:=round(PanelScale.Width div 2*16div 9/sumW*(IntegerByScale(5)+IntegerByScale(6)+IntegerByScale(7)) )//ширина кнопки потрійної("567")
                else if ((aScaleStr='23459')or(aScaleStr='25679'))and(aScaleStr[li-i]='9') then
                  Width:=round(PanelScale.Width div 2*16div 9/sumW*(IntegerByScale(8)+IntegerByScale(9)) )//ширина кнопки подвійної("89")
              end;
              Color:=clBtnFace
            end
            else begin
              if RButInteger.Checked then
                Width:=Width div (Length(aScaleStr)-2)
              else
                Width:=round(PanelScale.Width*16div 9 div 2/sumW*IntegerByScale(StrToInt(aScaleStr[li-i])));; //ширина одинарної червоної кнопки ("2","3", ...)
              Color:=clRed;
            end
          end
          else begin
            Width:=PanelScale.Width div 2;// div li;
            if RButInteger.Checked then
              Width:=Width*16div 9 div li
            else
              Width:=round(Width*16div 9 /sumW*IntegerByScale(1.5+(li-i-0.5)*(9.5-1.5)/li));    //16/9*
            Color:=clRed;
          end;
          inc(wi,Width);
          Left:=PanelScale.Width*(1-Reverse)-wi+2*wi*Reverse-Width*Reverse;
          Caption:='';
          Hint:=pref[StrToInt(aScaleStr[li-i])];
          BevelOuter:=bvRaised;
        end;
      end; //with
  end; //if reverse=-1
  //PanelScale.
  Invalidate;
end;//proc BuildScale

procedure TFormDynScaleInt.PanelScaleClick(Sender: TObject);
var st:string;
  Grad:integer;
begin
  with Sender as TPanel do begin
    if (Hint=LessMore[0])or(Hint=LessMore[1]) then begin
      PanelNoIdea.Caption:=Pref[1];
      PanelNoIdea.Hint:=PanelNoIdea.Caption;
      if Hint=LessMore[0] then
        Reverse:=0
      else
        Reverse:=1
    end;//if
    if ScaleStr='0' then begin
      Rel:=1;//вага оцінки при виборі половини шкали "менше / більше"
      Res:=5.5;//(1.5+9.5)/2
      ScaleStr:='259';
    end
    else if (Color<>clBtnFace) and (ScaleStr='259') then begin
      Grad:=1;
      while (Grad<=Length(ScaleStr))and (Hint<>Pref[StrToInt(ScaleStr[Grad])]) do
        inc(Grad);
      case Grad of
      1: ScaleStr:='23459';
      2: ScaleStr:='25679';
      3: ScaleStr:='2589'
      end;//case
      Rel:=3; //вага оцінки при виборі 1 із 3-х
      Res:=1.5+(Grad-0.5)*(9.5-1.5)/3; //2.8(3) / 5.5 / 8.1(6)
    end
    else if Color=clBtnFace then begin
      if Hint=Pref[2] then begin
        ScaleStr:='23459';
        Res:=1.5+(1-0.5)*(9.5-1.5)/3; //2.8(3)
      end
      else if Hint=Pref[5] then begin
        ScaleStr:='25679';
        Res:=1.5+(2-0.5)*(9.5-1.5)/3; //5.5
      end
      else if Hint=Pref[9] then begin
        ScaleStr:='2589';
        Res:=1.5+(3-0.5)*(9.5-1.5)/3; //8.1(6)
      end;
    end
    else begin//Color<>clBtnFace
      Grad:=1;
      while (Grad<=Length(ScaleStr))and (Hint<>Pref[StrToInt(ScaleStr[Grad])]) do
        inc(Grad);
      if (ScaleStr='23459')or(ScaleStr='25679')or(ScaleStr='2589') then begin
        if ScaleStr='25679' then
          inc(Grad,2)
        else if ScaleStr='2589' then
          inc(Grad,4);
        Rel:=8;
      end
      else
        Rel:=Length(ScaleStr); //вага оцінки при виборі 1 із ScaleStr
      Res:=1.5+(Grad-0.5)*(9.5-1.5)/Rel; // розрахунок при виході через кнопки на шкалі
      Close;
    end;//else Color<>clBtnFace
    BuildScale(ScaleStr);
    PanelScaleChoice.Show;
    st:=LessMore[Reverse];
    LabelIs.Caption:=LabelIs.Hint+' '+st;
  end;//with
  ShowImage;
end;

procedure TFormDynScaleInt.FormCreate(Sender: TObject);
begin
  Application.OnShowHint := DoShowHint;
end;

procedure TFormDynScaleInt.DoShowHint(var HintStr: String; var CanShow: Boolean; var HintInfo: THintInfo);
begin
  with HintInfo do begin
    if (HintControl is TPanel)and(HintControl<>PanelScaleButtonChoice) or (HintControl is TRadioButton) then begin
      HintColor := clWhite;// clAqua;{ Changes only for this hint }
      HintData:=@Data;
      if HintControl is TPanel then begin
        if PanelScaleChoice.Visible then begin
          if (TPanel(HintControl).Hint=Pref[1])// NoIdea
           or(TPanel(HintControl).Hint=LessMore[0])// Less
           or(TPanel(HintControl).Hint=LessMore[1])// More
          then
            Data:=Res
          else {if Data=1 then} begin //
            Data:=1;
            while (Data<10) and (TPanel(HintControl).Hint<>pref[round(Data)]) do
              Data:=Data+1;
          end;
          Data:=IntegerByScale(Data);
          if (Reverse=0)
           and(TPanel(HintControl).Hint<>LessMore[1])// not More
           or not(Reverse=0)
           and(TPanel(HintControl).Hint=LessMore[0])// Less
          then
            Data:=1/Data;
        end
        else if TPanel(HintControl).Hint=LessMore[0] then
          Data:=1/5.5
        else if TPanel(HintControl).Hint=LessMore[1] then
          Data:=5.5//(1.5+9.5)/2
        else begin
          Data:=1;
          //TPanel(HintControl).Hint:=LessMore[2]//Не можу визначитись
        end
      end else  // is tRBut
        if TRadioButton(HintControl).Name='RButInteger' then
          Data:=-1
        else if TRadioButton(HintControl).Name='RButBalanced' then
          Data:=-2
        else if TRadioButton(HintControl).Name='RButPower' then
          Data:=-3
        else if TRadioButton(HintControl).Name='RButMaZheng' then
          Data:=-4
        else if TRadioButton(HintControl).Name='RButDodd' then
          Data:=-5
    end;
  end;
end;

procedure TFormDynScaleInt.FormMouseWheelDown(Sender: TObject; Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
begin
  RxSpinButGradChangeBottomClick(Sender);
end;

procedure TFormDynScaleInt.FormMouseWheelUp(Sender: TObject; Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
begin
  RxSpinButGradChangeTopClick(Sender);
end;

procedure TFormDynScaleInt.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Deleteobject(font_);
  if Reverse>-1 then
    Res:=IntegerByScale(Res)
  else
    Rel:=0;
  if Reverse<0 then
    ScaleType:=0
  else if RButInteger.Checked then
    ScaleType:=1
  else if RButBalanced.Checked then
    ScaleType:=2
  else if RButPower.Checked then
    ScaleType:=3
  else if RButMaZheng.Checked then
    ScaleType:=4
  else if RButDodd.Checked then
    ScaleType:=5
end;

procedure TFormDynScaleInt.FormMouseWheel(Sender: TObject; Shift: TShiftState; WheelDelta: Integer; MousePos: TPoint; var Handled: Boolean);
begin
  Handled:=DelayWheel<3;
  inc(DelayWheel);
  if not Handled then DelayWheel:=0;
end;

procedure TFormDynScaleInt.PanelNoIdeaClick(Sender: TObject);
begin
  Close
end;

procedure TFormDynScaleInt.FormMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
var i:integer;
begin
  for i:=0 to PanelScale.ControlCount-1 do
    with PanelScale.Controls[i] as TPanel do
      BevelOuter:=bvRaised;
end;


procedure TFormDynScaleInt.PanelNoIdeaMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
var i:integer;
begin
  if (Data=1)and(Reverse=-1) then begin
    PanelMore.BevelOuter:=bvLowered;
    PanelLess.BevelOuter:=bvLowered;
  end;
  for i:=0 to PanelScale.ControlCount-1 do
    with PanelScale.Controls[i] as TPanel do
      if Color=clRed then
        BevelOuter:=bvLowered;
end;

procedure TFormDynScaleInt.PanelScaleMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
begin
  FormMouseMove(Sender,Shift,X, Y);
  with Sender as TPanel do begin
    BevelOuter:=bvLowered;
  end;
end;

procedure TFormDynScaleInt.PanelScaleChoiceClick(Sender: TObject);
begin
  BuildScale(ScaleStr);
  ShowImage;
end;

procedure TFormDynScaleInt.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key=VK_RETURN then
    PanelNoIdeaClick(Sender);
end;

procedure TFormDynScaleInt.RxSpinButGradChangeTopClick(Sender: TObject);
begin
  if (Reverse>-1)//and PtInRect(PanelScale.BoundsRect,Self.ScreenToClient(MousePos))
   and (length(ScaleStr)<8) then begin
    ScaleStr:=GradualScale[length(ScaleStr)+1];
    Rel:=1;//вага оцінки при виборі половини шкали "менше / більше"
    Res:=5.5;//(1.5+9.5)/2
    BuildScale(ScaleStr);
    ShowImage;
  end;//if
end;

procedure TFormDynScaleInt.RxSpinButGradChangeBottomClick(Sender: TObject);
begin
  if (Reverse>-1)//and PtInRect(PanelScale.BoundsRect,Self.ScreenToClient(MousePos))
   and (length(ScaleStr)>2) then begin
    ScaleStr:=GradualScale[length(ScaleStr)-1];
    Rel:=1;//вага оцінки при виборі половини шкали "менше / більше"
    Res:=5.5;//(1.5+9.5)/2
    BuildScale(ScaleStr);
    ShowImage;
  end;//if
end;

procedure TFormDynScaleInt.PanelScaleButtonChoiceClick(Sender: TObject);
var i:integer;
begin
  with Sender as TPanel do
    if BevelOuter=bvLowered then begin
      BevelOuter:=bvRaised;
      PanelScaleChoice.Height:=RxSpinButGradChange.Height;
    end else begin
      BevelOuter:=bvLowered;
      PanelScaleChoice.Height:=ImageShow.Height+ImageShow.Top-PanelScaleChoice.Top;
    end;
    for i:=0 to PanelScaleChoice.ControlCount-1 do
      TRadioButton(PanelScaleChoice.Controls[i]).Enabled:=BevelOuter=bvLowered
end;

end.
